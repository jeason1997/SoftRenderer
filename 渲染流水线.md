# 光栅化渲染流水线完整流程

## 1. 应用阶段（Application Stage）
- **任务**：由 CPU 主导，准备渲染所需的数据并触发渲染指令。
- **核心步骤**：
  - **场景构建**：定义 3D 物体（顶点、材质、纹理）、光源、相机位置和视角。
  - **排序**：
    - 对场景里的不透明物体按照相机空间进行Z轴排序，先绘制前面的，再绘制后面的，避免造成大量重复绘制增加Overdraw
  - **剔除（Culling）**：
    - **视锥体剔除**：移除相机视野外的物体。
    - **背面剔除**：移除物体背面（法线方向背离相机）的三角形。
    - **遮挡剔除**：移除被其他物体遮挡的三角形。
  - **LOD（Level of Detail）**：根据物体与相机的距离，选择不同精度的模型（远小近大）。
  - **设置渲染状态**：指定材质、纹理、光照模式等。
  - **输出**：将处理后的顶点数据和绘制命令传递给图形硬件（GPU）。

## 2. 几何阶段（Geometry Stage）
- **任务**：由 GPU 处理，将 3D 坐标转换为 2D 屏幕坐标，并处理几何信息。
- **核心步骤**：
  - ### 2.1 顶点着色器（Vertex Shader）
    对每个顶点执行计算，是流水线中必须实现的阶段。
    - **功能**：
      - **模型变换（Model Transformation）**：将顶点从局部坐标系转换到世界坐标系。
      - **视图变换（View Transformation）**：将世界坐标系顶点转换到相机坐标系（以相机为原点）。
      - **投影变换（Projection Transformation）**：
        - 正交投影：保留物体尺寸比例，适合 2D 或工程绘图。
        - 透视投影：模拟人眼透视效果（远处物体更小），转换为裁剪坐标系。
  
  - ### 2.2 曲面细分（Tessellation，可选）
    对高细节曲面（如贝塞尔曲线）进行细分，生成更多三角形，提升表面光滑度。
  
  - ### 2.3 几何着色器（Geometry Shader，可选）
    以图元（点、线、三角形）为单位处理，可新增/删除几何（如粒子系统生成粒子）。
  
  - ### 2.4 裁剪（Clipping）
    上面应用阶段的裁剪只是基于物体级别的粗略裁剪，可能存在物体的一部分在视锥体内，而另一部分在视体外的情况，这时候需要进行裁剪，移除完全位于视锥体之外的图元，部分重叠的图元会被分割。该阶段以三角形为单位（粒度小），需要处理的对象数量极大（通常是 millions 级别）。
    裁剪运算（如求交、新顶点生成）具有高度并行性（每个三角形的处理相互独立），恰好匹配 GPU 的大规模并行架构（千级流处理器同时工作）。
  
  - ### 2.5 屏幕映射（Screen Mapping）
    将裁剪坐标系的顶点转换为屏幕坐标系（像素坐标），确定顶点在屏幕上的位置。

## 3. 光栅化阶段（Rasterization Stage）
- **任务**：将几何阶段输出的图元（三角形）转换为像素（片元）。
- **核心步骤**：
  - ### 3.1 三角形设置（Triangle Setup）
    计算三角形的边方程和相关参数，为后续像素归属判断做准备。
  
  - ### 3.2 三角形遍历（Triangle Traversal）
    确定屏幕上哪些像素被三角形覆盖，生成片元（Fragment）（包含像素位置、深度、纹理坐标等信息）。
  
  - ### 3.3 提前深度测试（Early Depth Test）
    在片元着色器之前执行深度测试，可以提前剔除被遮挡的片元，避免不必要的着色计算。这种优化在场景深度复杂度高时特别有效，可以显著提升渲染性能。**但当片元着色器会修改深度值或使用透明效果时，提前深度测试可能会被禁用。**

## 4. 片元阶段（Fragment Stage）
- **任务**：计算每个片元的最终颜色，处理光照、纹理等细节。
- **核心步骤**：
  - ### 4.1 片元着色器（Fragment Shader）
    对每个片元执行计算，是流水线中高度可编程的阶段。
    - **功能**：
      - **纹理采样**：根据纹理坐标读取纹理颜色（如漫反射纹理、法线纹理）。
      - **光照计算**：应用 Phong、Blinn-Phong 等光照模型，计算环境光、漫反射、高光。
      - **颜色处理**：添加阴影、透明度、反射等效果。
  
  - ### 4.2 逐片元操作（Per-Fragment Operations）
    - **深度测试（Depth Test）**：比较片元深度与深度缓冲区，保留更靠近相机的片元。
    - **模板测试（Stencil Test）**：通过模板缓冲区控制片元可见性（如阴影遮罩、轮廓绘制）。
    - **混合（Blending）**：处理透明/半透明物体，将片元颜色与帧缓冲中已有颜色混合。
    - **抖动（Dithering）**：用有限颜色模拟更多色彩，减少带宽占用。
    - **输出合并（Output Merger）**：将最终颜色写入帧缓冲区（Frame Buffer）。

## 5. 显示阶段（Display Stage）
帧缓冲区中的数据被发送到显示器，按照刷新率逐行扫描显示，形成最终图像。

## 6. 补充，绘制顺序
- 阶段1：不透明物体
  - foreach(不透明物体)
      - 按相机空间深度从近到远排序（排序是为了降低Overdraw）
      - 顶点着色器 -> 光栅化
      - 早期深度测试（不通过则丢弃）
      - 像素着色器
      - 写入深度缓冲区和颜色缓冲区

- 阶段2：天空盒
    - 绘制天空盒（深度值设为最大值，只在无遮挡区域显示）

- 阶段3：透明物体
    - foreach(透明物体)
        - 按相机空间深度从远到近排序（排序是为了透明物体间的颜色混合结果正确，先蓝后红跟先红后蓝结果不一样）
        - 顶点着色器 -> 光栅化
        - 深度测试开启（仅读取深度缓冲区，判断是否被不透明物体遮挡）
        - 关闭深度写入（避免透明物体遮挡其他透明物体）
        - 像素着色器
        - 颜色混合（新透明色 × 透明度 + 颜色缓冲区已有颜色 × (1-透明度)）
        - 写入颜色缓冲区（不修改深度缓冲区）
