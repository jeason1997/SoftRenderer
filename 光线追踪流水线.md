光线追踪（Ray Tracing）的渲染流水线与传统光栅化流水线有本质区别，它基于“光线与物体相交检测”来生成图像，更贴近物理世界的光线传播规律。其核心流程可分为以下阶段：


### **1. 场景准备阶段（Scene Preparation）**
- **任务**：构建光线追踪所需的场景数据结构，为高效相交检测做准备。
- **核心步骤**：
  - **场景表示**：定义3D物体（几何体）、材质（反射率、折射率等）、光源（发光强度、类型）、相机参数（位置、视角、视野）。
  - **加速结构构建**：
    - 将场景中的几何体组织成**空间划分结构**（如BVH层次包围盒、KD树、Octree），大幅减少光线与物体的相交检测次数。
    - 对动态场景，需实时更新加速结构（开销较高，通常用于离线渲染或次世代实时光追）。
  - **数据预处理**：烘焙材质属性、光源采样信息等，优化后续计算效率。


### **2. 光线生成阶段（Ray Generation）**
- **任务**：从相机发射“主光线”（Primary Ray），每条光线对应屏幕上的一个像素。
- **核心步骤**：
  - **像素采样**：根据屏幕分辨率，为每个像素生成一个或多个采样点（抗锯齿需多采样）。
  - **主光线计算**：
    - 以相机位置为起点，通过采样点与相机近平面的交点，计算主光线的方向向量。
    - 记录光线的初始参数（起点、方向、波长范围等）。


### **3. 相交检测阶段（Intersection Testing）**
- **任务**：判断光线是否与场景中的物体相交，找到**最近交点**（决定像素颜色的关键）。
- **核心步骤**：
  - **加速结构遍历**：利用BVH等结构快速排除不相交的物体集合，缩小检测范围。
  - **几何体相交计算**：
    - 对候选物体，精确计算光线与三角形、球体等基元的交点（解几何方程）。
    - 记录交点信息：位置、所在物体的材质、法线方向、光线传播距离等。
  - **阴影检测**（可选）：对交点发射“阴影光线”（Shadow Ray）到光源，判断该点是否被其他物体遮挡。


### **4. 光线散射阶段（Ray Scattering）**
- **任务**：根据交点处的材质属性，计算光线的反射、折射、漫反射等散射方向，生成“次级光线”（Secondary Ray）。
- **核心步骤**：
  - **材质响应计算**：
    - **漫反射**：光线与粗糙表面碰撞后向随机方向散射（如Lambert模型）。
    - **镜面反射**：光线按反射定律反弹（如金属材质）。
    - **折射**：光线穿过透明物体时改变方向（如玻璃、水，需考虑Snell定律）。
    - **高光与光泽**：结合微表面模型（如GGX）计算反射光的分布范围。
  - **次级光线生成**：
    - 反射光线、折射光线：继续在场景中传播，重复相交检测流程。
    - 间接光照采样：通过随机采样（如路径追踪中的重要性采样）获取环境光或其他物体反射的光线。


### **5. 光线终止与颜色累积阶段（Ray Termination & Color Accumulation）**
- **任务**：确定光线传播的终止条件，并累积所有光线对像素颜色的贡献。
- **核心步骤**：
  - **终止条件判断**：
    - 光线传播到光源（直接光照贡献）。
    - 光线射出场景边界（贡献环境色）。
    - 光线能量衰减至阈值（避免无限递归）。
    - 达到最大反弹次数（平衡渲染质量与性能）。
  - **颜色计算**：
    - 直接光照：交点接收到的光源辐射量 × 材质反射率。
    - 间接光照：次级光线返回的颜色 × 材质散射系数。
    - 对多采样点（抗锯齿）或多光线路径（如路径追踪）的结果取平均值，得到最终像素颜色。


### **6. 后处理阶段（Post-Processing）**
- **任务**：优化输出图像的视觉效果。
- **常见步骤**：
  - 抗锯齿（如TAA时间抗锯齿）。
  - 降噪（针对光线追踪的噪点，如RTX的AI降噪）。
  - 色调映射（将高动态范围HDR颜色转换为显示器可显示的LDR范围）。
  - 景深、运动模糊等特效模拟。


### **与传统光栅化流水线的核心区别**
| 维度               | 光栅化流水线                     | 光线追踪流水线                     |
|--------------------|----------------------------------|------------------------------------|
| 核心原理           | 从物体到像素（投影-光栅化）      | 从像素到物体（光线相交检测）       |
| 并行性             | 顶点/片元级并行                  | 光线级并行                         |
| 真实感效果         | 依赖近似计算（如阴影贴图）       | 自然支持全局光照（反射、折射、焦散） |
| 性能瓶颈           | 三角形数量、像素填充率           | 光线反弹次数、相交检测复杂度       |
| 典型应用           | 实时渲染（游戏、VR）             | 离线渲染（电影、动画）、高端实时渲染 |


### 总结
光线追踪流水线以“光线传播”为核心，通过递归的相交检测和散射计算，自然模拟全局光照效果，但计算成本更高。现代实时光追（如NVIDIA RTX）通过硬件加速（RT Core）和优化算法（如分层BVH、重要性采样），已能在游戏中实现部分光追效果（如反射、阴影），但其流水线本质仍遵循“光线生成→相交检测→散射→累积”的逻辑。